# RAGè®­ç»ƒåœºæ™¯æµ‹è¯•è¯´æ˜

## ğŸ¯ ç›®çš„

æ¨¡æ‹Ÿå®é™…è®­ç»ƒè¿‡ç¨‹ä¸­çš„RAGè°ƒç”¨ï¼Œä½¿ç”¨çœŸå®çš„payloadæ ¼å¼æ¥éªŒè¯RAGæœåŠ¡æ˜¯å¦èƒ½æ­£å¸¸å“åº”ã€‚

## ğŸ”§ æµ‹è¯•è„šæœ¬æ›´æ–°

å·²æ›´æ–° `scripts/test_rag_call.py`ï¼Œæ–°å¢ `test_training_scenario()` å‡½æ•°ã€‚

### æµ‹è¯•å†…å®¹

#### æµ‹è¯•1ï¼šåŸºç¡€æ¥å£æµ‹è¯•
- ç®€å•çš„RAGè°ƒç”¨
- éªŒè¯åŸºæœ¬è¿æ¥æ€§

#### æµ‹è¯•2ï¼šPipelineå®Œæ•´æµ‹è¯•
- ä½¿ç”¨ `get_rag_rl_result` å‡½æ•°
- æ¨¡æ‹Ÿå®Œæ•´çš„æ•°æ®æµ

#### æµ‹è¯•3ï¼šè®­ç»ƒåœºæ™¯æµ‹è¯• â­ **æœ€é‡è¦**
- ä½¿ç”¨å®é™…è®­ç»ƒä¸­çš„payloadæ ¼å¼
- åŒ…å«å®Œæ•´çš„å‚æ•°ï¼š
  - `context`: çœŸå®çš„å¯¹è¯å†å²
  - `user_profile`: ç”¨æˆ·ç”»åƒ
  - `history_summary`: å†å²æ‘˜è¦
  - `rewritten_query`: æ”¹å†™æŸ¥è¯¢
  - `score_threshold`: 0.9
  - `top_k`: 3

## ğŸ“‹ æµ‹è¯•Payload

### 32Bè°ƒç”¨ (`/rag/chat`)
```json
{
  "tenant_id": "chengla",
  "contact_id": "Customer_knowledge_17",
  "account_id": "Sale_knowledge_17",
  "kb_name": "chengla",
  "thought_unit": "",
  "score_threshold": 0.9,
  "top_k": 3,
  "context": "<çœŸå®å¯¹è¯å†…å®¹>"
}
```

### 8Bè°ƒç”¨ (`/rag/chat_8b`)
```json
{
  "tenant_id": "chengla",
  "contact_id": "Customer_knowledge_17",
  "account_id": "Sale_knowledge_17",
  "kb_name": "chengla",
  "thought_unit": "",
  "score_threshold": 0.9,
  "top_k": 3,
  "context": "<çœŸå®å¯¹è¯å†…å®¹>",
  "user_profile": "ç”¨æˆ·ä¸ºåº”å±Šæ¯•ä¸šç”Ÿï¼Œæœ¬ç§‘åœ¨è¯»...",
  "history_summary": "ç”¨æˆ·å‚åŠ äº†2024å¹´ä¸‹åŠå¹´äº‹ä¸šå•ä½è”è€ƒ...",
  "rewritten_query": "äº‹ä¸šå•ä½è”è€ƒæ¯å¹´æ˜¯å¦ä¸¾è¡Œä¸¤æ¬¡ï¼Ÿ"
}
```

## ğŸš€ è¿è¡Œæµ‹è¯•

```bash
cd d:\å·¥ä½œæ–‡ä»¶\RAGå¼€å‘\Query_RL\Program\query_rl
python scripts/test_rag_call.py
```

## ğŸ“Š é¢„æœŸè¾“å‡º

### æˆåŠŸçš„è¾“å‡º
```
================================================================================
æ¨¡æ‹Ÿè®­ç»ƒåœºæ™¯çš„RAGè°ƒç”¨ï¼ˆä½¿ç”¨å®é™…è®­ç»ƒæ•°æ®ï¼‰
================================================================================

ğŸ”· æµ‹è¯•32Bè°ƒç”¨ï¼ˆè®­ç»ƒåœºæ™¯ï¼‰...
âœ… 32Bè°ƒç”¨æˆåŠŸ
  - çŠ¶æ€: success
  - è€—æ—¶: 1.23s
  - å“åº”é•¿åº¦: 3
  - ç¬¬ä¸€æ¡ç»“æœ: {"content": "...", "score": 0.95}...

ğŸ”¶ æµ‹è¯•8Bè°ƒç”¨ï¼ˆè®­ç»ƒåœºæ™¯ï¼‰...
âœ… 8Bè°ƒç”¨æˆåŠŸ
  - çŠ¶æ€: success
  - è€—æ—¶: 1.45s
  - å“åº”é•¿åº¦: 3
  - ç¬¬ä¸€æ¡ç»“æœ: {"content": "...", "score": 0.92}...

================================================================================
è®­ç»ƒåœºæ™¯æµ‹è¯•å®Œæˆ
================================================================================
```

### å¤±è´¥çš„è¾“å‡º
```
ğŸ”¶ æµ‹è¯•8Bè°ƒç”¨ï¼ˆè®­ç»ƒåœºæ™¯ï¼‰...
âŒ 8Bè°ƒç”¨å¤±è´¥: <é”™è¯¯ä¿¡æ¯>
Traceback (most recent call last):
  ...
```

## ğŸ” è¯Šæ–­æ­¥éª¤

### å¦‚æœæµ‹è¯•å¤±è´¥

#### 1. æ£€æŸ¥RAGæœåŠ¡çŠ¶æ€
```bash
curl http://127.0.0.1:7861/health
```

#### 2. æ‰‹åŠ¨æµ‹è¯•8Bæ¥å£
```bash
curl -X POST http://127.0.0.1:7861/rag/chat_8b \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_id": "chengla",
    "contact_id": "Customer_knowledge_17",
    "account_id": "Sale_knowledge_17",
    "kb_name": "chengla",
    "thought_unit": "",
    "score_threshold": 0.9,
    "top_k": 3,
    "context": "æµ‹è¯•å¯¹è¯",
    "user_profile": "æµ‹è¯•ç”¨æˆ·",
    "history_summary": "æµ‹è¯•æ‘˜è¦",
    "rewritten_query": "æµ‹è¯•æŸ¥è¯¢"
  }'
```

#### 3. æ£€æŸ¥æ—¥å¿—
æŸ¥çœ‹æµ‹è¯•è„šæœ¬çš„è¯¦ç»†è¾“å‡ºï¼ŒåŒ…æ‹¬ï¼š
- HTTPè¯·æ±‚URL
- è¯·æ±‚ä½“å†…å®¹
- å“åº”çŠ¶æ€ç 
- é”™è¯¯å †æ ˆ

#### 4. å¯¹æ¯”payload
ç¡®è®¤æµ‹è¯•è„šæœ¬ä¸­çš„payloadä¸ä½ æ‰‹åŠ¨æµ‹è¯•æˆåŠŸçš„payloadå®Œå…¨ä¸€è‡´ã€‚

## âœ… éªŒè¯æ¸…å•

æµ‹è¯•æˆåŠŸåï¼Œç¡®è®¤ï¼š
- [ ] 32Bè°ƒç”¨è¿”å›æœ‰æ•ˆæ•°æ®
- [ ] 8Bè°ƒç”¨è¿”å›æœ‰æ•ˆæ•°æ®
- [ ] å“åº”æ—¶é—´åˆç†ï¼ˆ< 5ç§’ï¼‰
- [ ] è¿”å›çš„æ•°æ®æ ¼å¼æ­£ç¡®
- [ ] æ²¡æœ‰å¼‚å¸¸æˆ–é”™è¯¯

## ğŸ¯ ä¸è®­ç»ƒçš„å…³ç³»

### æµ‹è¯•æˆåŠŸæ„å‘³ç€ï¼š
1. âœ… RAGæœåŠ¡æ­£å¸¸è¿è¡Œ
2. âœ… å‚æ•°æ ¼å¼æ­£ç¡®
3. âœ… ç½‘ç»œè¿æ¥æ­£å¸¸
4. âœ… å¯ä»¥å¼€å§‹è®­ç»ƒ

### å¦‚æœæµ‹è¯•æˆåŠŸä½†è®­ç»ƒå¤±è´¥ï¼š
å¯èƒ½çš„åŸå› ï¼š
1. è®­ç»ƒä»£ç ä¸­çš„å‚æ•°ä¼ é€’æœ‰é—®é¢˜
2. å¼‚æ­¥è°ƒç”¨çš„é—®é¢˜
3. è®­ç»ƒç¯å¢ƒä¸æµ‹è¯•ç¯å¢ƒä¸åŒ

éœ€è¦æ£€æŸ¥ï¼š
- `src/pipeline.py` ä¸­çš„å‚æ•°ä¼ é€’
- `verl_code/verl/trainer/ppo/ray_trainer.py` ä¸­çš„RAGè°ƒç”¨
- è®­ç»ƒæ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

## ğŸ“ ä¸‹ä¸€æ­¥

### å¦‚æœæµ‹è¯•å…¨éƒ¨æˆåŠŸ
```bash
# é‡æ–°å¯åŠ¨è®­ç»ƒ
cd verl_code
bash your_training_script.sh
```

### å¦‚æœæµ‹è¯•å¤±è´¥
1. æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥RAGæœåŠ¡æ—¥å¿—
3. å¯¹æ¯”æˆåŠŸçš„æ‰‹åŠ¨è°ƒç”¨ä¸å¤±è´¥çš„è„šæœ¬è°ƒç”¨
4. å‚è€ƒ `RAG_CALL_TROUBLESHOOTING.md`

## ğŸ’¡ æç¤º

- è¿™ä¸ªæµ‹è¯•ä½¿ç”¨çš„payloadæ ¼å¼ä¸ä½ æ‰‹åŠ¨æµ‹è¯•æˆåŠŸçš„æ ¼å¼å®Œå…¨ä¸€è‡´
- å¦‚æœè¿™ä¸ªæµ‹è¯•æˆåŠŸï¼Œè¯´æ˜ä»£ç å±‚é¢æ²¡é—®é¢˜
- å¦‚æœè®­ç»ƒæ—¶ä»ç„¶å¤±è´¥ï¼Œé—®é¢˜å¯èƒ½åœ¨è®­ç»ƒæ¡†æ¶çš„é›†æˆéƒ¨åˆ†
