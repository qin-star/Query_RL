# System Prompt ä¿®æ”¹åçš„è„šæœ¬è°ƒæ•´è¯´æ˜

## ğŸ“Š é—®é¢˜åˆ†æ

ä½ ä¿®æ”¹åçš„system promptåŒ…å«äº†**ç»“æ„åŒ–è¾“å…¥è¦æ±‚**ï¼ŒæœŸæœ›ï¼š
- **å†å²å¯¹è¯å†…å®¹**ï¼ˆ`{{history_chat}}`ï¼‰
- **ç”¨æˆ·å½“å‰è¾“å…¥**ï¼ˆ`{{query}}`ï¼‰  
- **å¯é€‰çš„æ€è·¯æç¤º**ï¼ˆ`{{thought}}`ï¼‰

ä½†åŸè„šæœ¬å°†**æ•´ä¸ªå¯¹è¯å†å²ä½œä¸ºä¸€ä¸ªæ•´ä½“**ä¼ å…¥ï¼Œæ²¡æœ‰åšæ‹†åˆ†ã€‚

---

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. **ä¿®æ”¹äº† `convert_to_messages_format` å‡½æ•°**

**ä¿®æ”¹å‰**ï¼š
```python
# ç”¨æˆ·è¾“å…¥ï¼šåªæä¾›å¯¹è¯å†å²
user_content = f"""è¯·åˆ†æä»¥ä¸‹é”€å”®-å®¢æˆ·å¯¹è¯å†å²ï¼Œç”Ÿæˆç”¨æˆ·ç”»åƒã€å†å²æ‘˜è¦å’Œæ”¹å†™é—®é¢˜ï¼š

å¯¹è¯å†å²ï¼š
{context}  # æ•´ä¸ªå¯¹è¯å†å²ä½œä¸ºä¸€ä¸ªæ•´ä½“

è¯·ä»¥JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœã€‚"""
```

**ä¿®æ”¹å**ï¼š
```python
# æ‹†åˆ†å¯¹è¯å†å²ï¼šæå–æœ€åä¸€æ¡å®¢æˆ·æ¶ˆæ¯ä½œä¸ºå½“å‰query
lines = context.strip().split('\n')

# ä»åå¾€å‰æ‰¾æœ€åä¸€æ¡[å®¢æˆ·]æ¶ˆæ¯
current_query = ""
history_chat = ""

for i in range(len(lines) - 1, -1, -1):
    line = lines[i].strip()
    if line.startswith('[å®¢æˆ·]'):
        # æ‰¾åˆ°æœ€åä¸€æ¡å®¢æˆ·æ¶ˆæ¯
        if 'ï¼š' in line:
            current_query = line.split('ï¼š', 1)[1].strip()
        else:
            current_query = line
        
        # å…¶ä½™éƒ¨åˆ†ä½œä¸ºå†å²å¯¹è¯
        history_chat = '\n'.join(lines[:i]) if i > 0 else ""
        break

# æ„å»ºç”¨æˆ·è¾“å…¥ - åŒ¹é…system promptçš„ç»“æ„
user_content = f"""è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œä¾æ¬¡å®Œæˆä¸‰ä¸ªä»»åŠ¡ï¼š

## è¾“å…¥ä¿¡æ¯

- å†å²å¯¹è¯å†…å®¹ï¼š
{history_chat if history_chat else "ï¼ˆæ— å†å²å¯¹è¯ï¼‰"}

- ç”¨æˆ·å½“å‰è¾“å…¥ï¼š
{current_query}

è¯·æŒ‰ç…§è¦æ±‚è¾“å‡ºJSONæ ¼å¼çš„åˆ†æç»“æœã€‚"""
```

**å…³é”®æ”¹åŠ¨**ï¼š
1. âœ… æå–æœ€åä¸€æ¡`[å®¢æˆ·]`æ¶ˆæ¯ä½œä¸º`current_query`
2. âœ… å°†ä¹‹å‰çš„å¯¹è¯ä½œä¸º`history_chat`
3. âœ… æŒ‰ç…§system promptçš„ç»“æ„ç»„ç»‡è¾“å…¥

---

## ğŸ” System Prompt ä¸­çš„æ³¨æ„ç‚¹

### 1. **å ä½ç¬¦è¯­æ³•è¯´æ˜**

ä½ çš„system promptä¸­ä½¿ç”¨äº†Jinja2é£æ ¼çš„å ä½ç¬¦ï¼š
```
{{history_chat}}
{{query}}
{{thought}}
```

**è¯´æ˜**ï¼šè¿™äº›åªæ˜¯**ç¤ºä¾‹å ä½ç¬¦**ï¼Œç”¨äºè¯´æ˜è¾“å…¥æ ¼å¼ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼š
- æˆ‘ä»¬ç”¨Pythonçš„f-stringæ¥å¡«å……è¿™äº›å†…å®¹
- ä¸éœ€è¦çœŸçš„ä½¿ç”¨Jinja2æ¨¡æ¿å¼•æ“

### 2. **å¯é€‰å­—æ®µ `thought`**

System promptä¸­æåˆ°äº†å¯é€‰çš„`{{thought}}`å­—æ®µï¼š
```
{% if thought %}
- é”€å”®æ€è·¯æç¤ºï¼ˆå¯é€‰ï¼‰ï¼š
"{{thought}}"
{% endif %}
```

**å½“å‰å¤„ç†**ï¼š
- ä½ çš„æ•°æ®é›†ä¸­**æ²¡æœ‰**è¿™ä¸ªå­—æ®µ
- å½“å‰è„šæœ¬**æ²¡æœ‰**ä¼ å…¥thought
- å¦‚æœæœªæ¥éœ€è¦ï¼Œå¯ä»¥åœ¨user_contentä¸­æ·»åŠ 

---

## ğŸ“ è®­ç»ƒæ•°æ®æ ¼å¼ç¤ºä¾‹

### å®Œæ•´çš„è®­ç»ƒæ ·æœ¬ç»“æ„

```json
{
  "messages": [
    {
      "role": "system",
      "content": "## èƒŒæ™¯\nä½ æ˜¯æ•™åŸ¹è¡Œä¸šçš„å¯¹è¯ç†è§£ä¸ç”¨æˆ·æ´å¯Ÿä¸“å®¶...\n\nï¼ˆå®Œæ•´system promptï¼‰"
    },
    {
      "role": "user",
      "content": "è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œä¾æ¬¡å®Œæˆä¸‰ä¸ªä»»åŠ¡ï¼š\n\n## è¾“å…¥ä¿¡æ¯\n\n- å†å²å¯¹è¯å†…å®¹ï¼š\n[é”€å”®][2025-03-03 20:47:47]ï¼šéº»çƒ¦å’±ä»¬å­©å­åŠ è€å¸ˆå¾®ä¿¡...\n[å®¢æˆ·][2025-03-03 20:48:25]ï¼šå’Œå­©å­è¿˜æ²¡è”ç³»ä¸Š\n...\n\n- ç”¨æˆ·å½“å‰è¾“å…¥ï¼š\nä»¥åå­©å­å¬è¯¾åœ¨è¿™é‡Œå—ï¼Ÿ\n\nè¯·æŒ‰ç…§è¦æ±‚è¾“å‡ºJSONæ ¼å¼çš„åˆ†æç»“æœã€‚"
    },
    {
      "role": "assistant",
      "content": "{\n  \"user_profile\": \"ç”¨æˆ·ä¸ºå®¶é•¿ï¼Œå­©å­åœ¨å¤§å­¦è¯»ä¹¦ï¼Œæ­£åœ¨ä¸ºå­©å­æŠ¥åå…¬è€ƒåŸ¹è®­è¯¾ç¨‹\",\n  \"history_summary\": \"ç”¨æˆ·æ­£åœ¨ä¸ºå­©å­æŠ¥åè¯¾ç¨‹ï¼Œå…³å¿ƒè¯¾ç¨‹å­¦ä¹ æ–¹å¼å’Œå¹³å°\",\n  \"rewritten_query\": \"æ©™å•¦å…¬è€ƒè¯¾ç¨‹çš„å­¦ä¹ å¹³å°åœ¨å“ªé‡Œï¼Ÿå¦‚ä½•å¬è¯¾ï¼Ÿ\"\n}"
    }
  ],
  "metadata": {
    "source": "chengla_rl_dataset",
    "tenant_id": "chengla",
    "sample_id": "chengla_v2_1",
    "original_query": "ä»¥åå­©å­å¬è¯¾åœ¨è¿™é‡Œå—ï¼Ÿ",
    "task_type": "multi_output"
  }
}
```

---

## âœ… éªŒè¯æµ‹è¯•

å·²åˆ›å»ºæµ‹è¯•è„šæœ¬ `test_data_format.py`ï¼ŒéªŒè¯ç»“æœï¼š

### æµ‹è¯•1ï¼šæ­£å¸¸å¯¹è¯æ‹†åˆ†
```
ã€åŸå§‹å¯¹è¯ã€‘
[é”€å”®][...]ï¼šéº»çƒ¦å’±ä»¬å­©å­åŠ è€å¸ˆå¾®ä¿¡...
[å®¢æˆ·][...]ï¼šå’Œå­©å­è¿˜æ²¡è”ç³»ä¸Š
...
[å®¢æˆ·][...]ï¼šä»¥åå­©å­å¬è¯¾åœ¨è¿™é‡Œå—ï¼Ÿ

ã€æ‹†åˆ†ç»“æœã€‘
âœ… å†å²å¯¹è¯ï¼š6è¡Œå¯¹è¯å†å²
âœ… å½“å‰queryï¼šä»¥åå­©å­å¬è¯¾åœ¨è¿™é‡Œå—ï¼Ÿ
```

### æµ‹è¯•2ï¼šè¾¹ç¼˜æƒ…å†µ
- âœ… åªæœ‰ä¸€æ¡å®¢æˆ·æ¶ˆæ¯ â†’ å†å²ä¸ºç©ºï¼Œqueryæ­£ç¡®æå–
- âœ… å¤šæ¡äº¤æ›¿å¯¹è¯ â†’ æ­£ç¡®æ‹†åˆ†å†å²å’Œå½“å‰query

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. è¿è¡Œè½¬æ¢è„šæœ¬

```bash
python convert_to_sft_format_v2.py
```

**è¾“å‡º**ï¼š
```
data/sft/chengla_v2/
â”œâ”€â”€ train_latest.jsonl      # è®­ç»ƒé›†
â”œâ”€â”€ val_latest.jsonl        # éªŒè¯é›†
â”œâ”€â”€ test_latest.jsonl       # æµ‹è¯•é›†
â”œâ”€â”€ stats_report.json       # ç»Ÿè®¡æŠ¥å‘Š
â””â”€â”€ sample_examples.json    # æ ·æœ¬ç¤ºä¾‹
```

### 2. æ£€æŸ¥ç”Ÿæˆçš„æ•°æ®

```bash
# æŸ¥çœ‹æ ·æœ¬ç¤ºä¾‹
cat data/sft/chengla_v2/sample_examples.json

# æŸ¥çœ‹ç»Ÿè®¡æŠ¥å‘Š
cat data/sft/chengla_v2/stats_report.json

# æŸ¥çœ‹ç¬¬ä¸€æ¡è®­ç»ƒæ•°æ®
head -n 1 data/sft/chengla_v2/train_latest.jsonl | python -m json.tool
```

---

## ğŸ¯ åç»­å»ºè®®

### 1. **æ˜¯å¦éœ€è¦æ·»åŠ  `thought` å­—æ®µï¼Ÿ**

å¦‚æœä½ çš„å®é™…åº”ç”¨ä¸­éœ€è¦"é”€å”®æ€è·¯æç¤º"ï¼Œå¯ä»¥ï¼š

**é€‰é¡¹Aï¼šå¿½ç•¥thoughtå­—æ®µ**
- å½“å‰æ•°æ®é›†æ²¡æœ‰è¿™ä¸ªå­—æ®µ
- System promptä¸­æ ‡è®°ä¸ºå¯é€‰
- è®­ç»ƒæ—¶æ¨¡å‹ä¼šå­¦ä¹ åœ¨æ²¡æœ‰thoughtçš„æƒ…å†µä¸‹å·¥ä½œ

**é€‰é¡¹Bï¼šæ·»åŠ thoughtå­—æ®µ**
- å¦‚æœæœªæ¥æœ‰è¿™ä¸ªæ•°æ®ï¼Œä¿®æ”¹`convert_to_messages_format`å‡½æ•°
- åœ¨user_contentä¸­æ·»åŠ thoughtéƒ¨åˆ†

### 2. **System Prompt ä¼˜åŒ–å»ºè®®**

å½“å‰system promptå¾ˆè¯¦ç»†ï¼ˆ~100è¡Œï¼‰ï¼Œå¯ä»¥è€ƒè™‘ï¼š

**ä¼˜åŒ–1ï¼šç®€åŒ–ç‰ˆæœ¬**ï¼ˆç”¨äºå¿«é€ŸéªŒè¯ï¼‰
```python
system_prompt_simple = """ä½ æ˜¯æ•™åŸ¹è¡Œä¸šå¯¹è¯åˆ†æä¸“å®¶ã€‚

ä»»åŠ¡ï¼šåˆ†æå¯¹è¯å†å²ï¼Œè¾“å‡ºJSONæ ¼å¼ï¼š
{
  "user_profile": "ç”¨æˆ·ç”»åƒ",
  "history_summary": "å†å²æ‘˜è¦",
  "rewritten_query": "æ”¹å†™é—®é¢˜"
}

è¾“å…¥ï¼š
- å†å²å¯¹è¯å†…å®¹
- ç”¨æˆ·å½“å‰è¾“å…¥

è¦æ±‚ï¼šä¿æŒè‡ªç„¶ï¼Œä¸ç¼–é€ ä¿¡æ¯ã€‚"""
```

**ä¼˜åŒ–2ï¼šå»æ‰å ä½ç¬¦è¯­æ³•**

å°†system promptä¸­çš„`{{history_chat}}`ã€`{{query}}`ç­‰æ”¹ä¸ºç›´æ¥è¯´æ˜ï¼š
```
## è¾“å…¥ä¿¡æ¯è¯´æ˜
ä½ å°†æ”¶åˆ°ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼š
1. å†å²å¯¹è¯å†…å®¹
2. ç”¨æˆ·å½“å‰è¾“å…¥
```

### 3. **æ•°æ®è´¨é‡æ£€æŸ¥**

è½¬æ¢åå»ºè®®æ£€æŸ¥ï¼š
```python
# æ£€æŸ¥è„šæœ¬
import json

with open('data/sft/chengla_v2/train_latest.jsonl') as f:
    for i, line in enumerate(f):
        if i >= 5:  # åªæ£€æŸ¥å‰5æ¡
            break
        
        sample = json.loads(line)
        
        # æ£€æŸ¥1ï¼šuser contentæ˜¯å¦åŒ…å«"å†å²å¯¹è¯å†…å®¹"å’Œ"ç”¨æˆ·å½“å‰è¾“å…¥"
        user_msg = sample['messages'][1]['content']
        assert 'å†å²å¯¹è¯å†…å®¹' in user_msg
        assert 'ç”¨æˆ·å½“å‰è¾“å…¥' in user_msg
        
        # æ£€æŸ¥2ï¼šassistantè¾“å‡ºæ˜¯å¦ä¸ºåˆæ³•JSON
        assistant_msg = sample['messages'][2]['content']
        output = json.loads(assistant_msg)
        assert 'user_profile' in output
        assert 'history_summary' in output
        assert 'rewritten_query' in output
        
        print(f"âœ… æ ·æœ¬ {i+1} æ ¼å¼æ­£ç¡®")
```

---

## ğŸ“Œ æ€»ç»“

### ä¿®æ”¹æ¸…å•

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ‹†åˆ†å¯¹è¯å†å²å’Œå½“å‰query | âœ… å·²å®Œæˆ | `convert_to_messages_format`å‡½æ•°å·²ä¿®æ”¹ |
| åŒ¹é…system promptç»“æ„ | âœ… å·²å®Œæˆ | user_contentæ ¼å¼å·²è°ƒæ•´ |
| æµ‹è¯•éªŒè¯ | âœ… å·²å®Œæˆ | åˆ›å»ºäº†`test_data_format.py` |
| æ–‡æ¡£è¯´æ˜ | âœ… å·²å®Œæˆ | æœ¬æ–‡æ¡£ |

### å¯é€‰ä¼˜åŒ–

| é¡¹ç›® | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| æ·»åŠ thoughtå­—æ®µæ”¯æŒ | ä½ | å½“å‰æ•°æ®é›†æ— æ­¤å­—æ®µ |
| ç®€åŒ–system prompt | ä¸­ | å¦‚æœæ¨¡å‹å­¦ä¹ å›°éš¾å¯è€ƒè™‘ |
| æ·»åŠ æ•°æ®è´¨é‡æ£€æŸ¥ | é«˜ | è®­ç»ƒå‰å»ºè®®æ‰§è¡Œ |

---

## â“ FAQ

### Q1: System promptå¤ªé•¿ä¼šæœ‰é—®é¢˜å—ï¼Ÿ

**A**: ä¸ä¼šï¼Œä½†å¯èƒ½ï¼š
- å¢åŠ tokenæ¶ˆè€—
- å½±å“æ¨¡å‹å­¦ä¹ æ•ˆç‡ï¼ˆå¦‚æœè§„åˆ™å¤ªå¤æ‚ï¼‰

**å»ºè®®**ï¼šå…ˆç”¨å½“å‰ç‰ˆæœ¬è®­ç»ƒï¼Œå¦‚æœæ•ˆæœä¸å¥½å†ç®€åŒ–ã€‚

### Q2: ä¸ºä»€ä¹ˆè¦æ‹†åˆ†å†å²å¯¹è¯å’Œå½“å‰queryï¼Ÿ

**A**: 
1. **åŒ¹é…system promptçš„ç»“æ„**ï¼šä½ çš„promptæ˜ç¡®è¦æ±‚åˆ†å¼€è¾“å…¥
2. **æ›´æ¸…æ™°çš„è¯­ä¹‰**ï¼šå¸®åŠ©æ¨¡å‹ç†è§£å“ªä¸ªæ˜¯éœ€è¦æ”¹å†™çš„é—®é¢˜
3. **æ›´å¥½çš„è®­ç»ƒæ•ˆæœ**ï¼šç»“æ„åŒ–è¾“å…¥æœ‰åŠ©äºæ¨¡å‹å­¦ä¹ 

### Q3: å¦‚æœå¯¹è¯å†å²ä¸­æœ‰å¤šæ¡å®¢æˆ·æ¶ˆæ¯æ€ä¹ˆåŠï¼Ÿ

**A**: 
- å½“å‰é€»è¾‘ï¼šå–**æœ€åä¸€æ¡**`[å®¢æˆ·]`æ¶ˆæ¯ä½œä¸ºcurrent_query
- å…¶ä½™æ‰€æœ‰å†…å®¹ï¼ˆåŒ…æ‹¬ä¹‹å‰çš„å®¢æˆ·æ¶ˆæ¯ï¼‰ä½œä¸ºhistory_chat
- è¿™ç¬¦åˆå¤šè½®å¯¹è¯çš„åœºæ™¯

---

## ğŸ‰ å‡†å¤‡å¼€å§‹è®­ç»ƒ

å½“å‰è„šæœ¬å·²ç»å®Œå…¨é€‚é…ä½ ä¿®æ”¹åçš„system promptï¼

**ä¸‹ä¸€æ­¥**ï¼š
```bash
# 1. è¿è¡Œè½¬æ¢è„šæœ¬
python convert_to_sft_format_v2.py

# 2. æ£€æŸ¥ç”Ÿæˆçš„æ•°æ®
python -c "import json; print(json.dumps(json.loads(open('data/sft/chengla_v2/sample_examples.json').read())[0], ensure_ascii=False, indent=2))"

# 3. å¼€å§‹è®­ç»ƒï¼ˆå‚è€ƒMDæ–‡æ¡£ä¸­çš„ms-swiftå‘½ä»¤ï¼‰
```


