# SFTè®­ç»ƒæ•°æ®æ ¼å¼å¯¹æ¯”è¯´æ˜

## ä¸¤ä¸ªç‰ˆæœ¬çš„åŒºåˆ«

### Version 1: å•ä¸€ä»»åŠ¡ï¼ˆQueryæ”¹å†™ï¼‰

**è®­ç»ƒç›®æ ‡**ï¼šå­¦ä¹ å¦‚ä½•æ”¹å†™query

**è¾“å…¥æ ¼å¼**ï¼š
```
åŸå§‹é—®é¢˜: æ©™å•¦APPåœ¨å“ªé‡Œä¸‹è½½ï¼Ÿ

ç”¨æˆ·ç”»åƒ: ç”¨æˆ·ä¸ºè¥¿å®‰åŒ»å­¦é™¢è¯å­¦ä¸“ä¸šå¤§äºŒæœ¬ç§‘ç”Ÿï¼Œæ­£åœ¨å¤‡è€ƒå…¬è€ƒ...

å†å²æ‘˜è¦: ç”¨æˆ·æ­£åœ¨ä¸ºå­©å­æŠ¥åè¯¾ç¨‹ï¼Œå­©å­ç›®å‰åœ¨è¥¿å®‰åŒ»å­¦é™¢è¯»è¯å­¦æœ¬ç§‘...

è¯·æ”¹å†™è¿™ä¸ªé—®é¢˜ï¼Œä½¿å…¶æ›´é€‚åˆçŸ¥è¯†åº“æ£€ç´¢ã€‚
```

**è¾“å‡ºæ ¼å¼**ï¼š
```
æ©™å•¦APPåœ¨å“ªé‡Œå¯ä»¥ä¸‹è½½ï¼Ÿ
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä»»åŠ¡å•ä¸€ï¼Œæ¨¡å‹å®¹æ˜“å­¦ä¹ 
- âœ… è¾“å‡ºç®€æ´ï¼Œæ˜“äºè§£æ
- âœ… é€‚åˆä¸“æ³¨äºqueryæ”¹å†™çš„åœºæ™¯

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦é¢„å…ˆç”Ÿæˆuser_profileå’Œhistory_summary
- âŒ æ— æ³•ç«¯åˆ°ç«¯è®­ç»ƒ


---

### Version 2: å¤šä»»åŠ¡è¾“å‡ºï¼ˆä½ çš„æ–°éœ€æ±‚ï¼‰

**è®­ç»ƒç›®æ ‡**ï¼šä»å¯¹è¯å†å²ä¸­åŒæ—¶ç†è§£å¹¶ç”Ÿæˆä¸‰ä¸ªä¿¡æ¯

**è¾“å…¥æ ¼å¼**ï¼š
```
è¯·åˆ†æä»¥ä¸‹é”€å”®-å®¢æˆ·å¯¹è¯å†å²ï¼Œç”Ÿæˆç”¨æˆ·ç”»åƒã€å†å²æ‘˜è¦å’Œæ”¹å†™é—®é¢˜ï¼š

å¯¹è¯å†å²ï¼š
[é”€å”®][2025-03-03 20:47:47]ï¼šéº»çƒ¦å’±ä»¬å­©å­åŠ è€å¸ˆå¾®ä¿¡...
[å®¢æˆ·][2025-03-03 20:48:25]ï¼šå’Œå­©å­è¿˜æ²¡è”ç³»ä¸Š
[å®¢æˆ·][2025-03-03 20:48:58]ï¼šå¥¹æœ€è¿‘å¾ˆå¿™ï¼Œæˆ‘ç»™å‘ä¿¡æ¯äº†
...
[å®¢æˆ·][2025-03-03 20:51:06]ï¼šæ˜¯å­©å­ä¸Šå¤§äºŒ
...

è¯·ä»¥JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœã€‚
```

**è¾“å‡ºæ ¼å¼**ï¼š
```json
{
  "user_profile": "ç”¨æˆ·ä¸ºè¥¿å®‰åŒ»å­¦é™¢è¯å­¦ä¸“ä¸šå¤§äºŒæœ¬ç§‘ç”Ÿï¼Œæ­£åœ¨å¤‡è€ƒå…¬è€ƒï¼Œå…³æ³¨è¯¾ç¨‹å­¦ä¹ æ–¹å¼å’Œå­¦ä¹ èµ„æºè·å–ã€‚",
  "history_summary": "ç”¨æˆ·æ­£åœ¨ä¸ºå­©å­æŠ¥åè¯¾ç¨‹ï¼Œå­©å­ç›®å‰åœ¨è¥¿å®‰åŒ»å­¦é™¢è¯»è¯å­¦æœ¬ç§‘ï¼Œè¯¾ç¨‹é€šè¿‡æ©™å•¦APPè¿›è¡Œï¼Œç”¨æˆ·å…³å¿ƒè¯¾ç¨‹ä¸‹è½½å’Œå­¦ä¹ æ–¹å¼ã€‚",
  "rewritten_query": "æ©™å•¦APPåœ¨å“ªé‡Œå¯ä»¥ä¸‹è½½ï¼Ÿ"
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç«¯åˆ°ç«¯è®­ç»ƒï¼Œæ— éœ€é¢„å¤„ç†
- âœ… æ¨¡å‹å­¦ä¹ æ›´å…¨é¢çš„ç†è§£èƒ½åŠ›
- âœ… ä¸‰ä¸ªä»»åŠ¡äº’ç›¸ä¿ƒè¿›ï¼Œæå‡æ•´ä½“æ•ˆæœ
- âœ… æ›´ç¬¦åˆå®é™…åº”ç”¨åœºæ™¯

**ç¼ºç‚¹**ï¼š
- âŒ è®­ç»ƒéš¾åº¦æ›´å¤§ï¼Œéœ€è¦æ›´å¤šæ•°æ®
- âŒ éœ€è¦æ¨¡å‹èƒ½æ­£ç¡®ç”ŸæˆJSONæ ¼å¼
- âŒ æ¨ç†æ—¶éœ€è¦è§£æJSONè¾“å‡º


---

## è®­ç»ƒæ•°æ®æ ·æœ¬å¯¹æ¯”

### Version 1 æ ·æœ¬ç¤ºä¾‹

```json
{
  "messages": [
    {
      "role": "system",
      "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•™è‚²åŸ¹è®­çŸ¥è¯†åº“æŸ¥è¯¢ä¼˜åŒ–ä¸“å®¶..."
    },
    {
      "role": "user",
      "content": "åŸå§‹é—®é¢˜: æ©™å•¦APPåœ¨å“ªé‡Œä¸‹è½½ï¼Ÿ\n\nç”¨æˆ·ç”»åƒ: ç”¨æˆ·ä¸ºè¥¿å®‰åŒ»å­¦é™¢è¯å­¦ä¸“ä¸šå¤§äºŒæœ¬ç§‘ç”Ÿ...\n\nè¯·æ”¹å†™è¿™ä¸ªé—®é¢˜ï¼Œä½¿å…¶æ›´é€‚åˆçŸ¥è¯†åº“æ£€ç´¢ã€‚"
    },
    {
      "role": "assistant",
      "content": "æ©™å•¦APPåœ¨å“ªé‡Œå¯ä»¥ä¸‹è½½ï¼Ÿ"
    }
  ]
}
```

### Version 2 æ ·æœ¬ç¤ºä¾‹

```json
{
  "messages": [
    {
      "role": "system",
      "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•™è‚²åŸ¹è®­é¢†åŸŸæ™ºèƒ½åˆ†æåŠ©æ‰‹..."
    },
    {
      "role": "user",
      "content": "è¯·åˆ†æä»¥ä¸‹é”€å”®-å®¢æˆ·å¯¹è¯å†å²ï¼Œç”Ÿæˆç”¨æˆ·ç”»åƒã€å†å²æ‘˜è¦å’Œæ”¹å†™é—®é¢˜ï¼š\n\nå¯¹è¯å†å²ï¼š\n[é”€å”®][2025-03-03 20:47:47]ï¼šéº»çƒ¦å’±ä»¬å­©å­åŠ è€å¸ˆå¾®ä¿¡...\n..."
    },
    {
      "role": "assistant",
      "content": "{\n  \"user_profile\": \"ç”¨æˆ·ä¸ºè¥¿å®‰åŒ»å­¦é™¢è¯å­¦ä¸“ä¸šå¤§äºŒæœ¬ç§‘ç”Ÿ...\",\n  \"history_summary\": \"ç”¨æˆ·æ­£åœ¨ä¸ºå­©å­æŠ¥åè¯¾ç¨‹...\",\n  \"rewritten_query\": \"æ©™å•¦APPåœ¨å“ªé‡Œå¯ä»¥ä¸‹è½½ï¼Ÿ\"\n}"
    }
  ]
}
```


---

## å»ºè®®ä¸é€‰æ‹©

### ğŸ¯ æ¨èä½¿ç”¨ Version 2 çš„åœºæ™¯ï¼š

1. **ä½ æœ‰å®Œæ•´çš„å¯¹è¯å†å²æ•°æ®**ï¼ˆâœ… ä½ çš„æƒ…å†µï¼‰
2. **å¸Œæœ›ç«¯åˆ°ç«¯è®­ç»ƒ**ï¼Œå‡å°‘äººå·¥æ ‡æ³¨
3. **éœ€è¦æ¨¡å‹å…·å¤‡å…¨é¢çš„ç†è§£èƒ½åŠ›**
4. **æ„¿æ„æŠ•å…¥æ›´å¤šè®­ç»ƒèµ„æº**

### ğŸ¯ æ¨èä½¿ç”¨ Version 1 çš„åœºæ™¯ï¼š

1. åªå…³æ³¨queryæ”¹å†™è´¨é‡
2. è®­ç»ƒèµ„æºæœ‰é™
3. éœ€è¦å¿«é€ŸéªŒè¯æ•ˆæœ
4. å·²æœ‰é¢„å¤„ç†çš„user_profileå’Œhistory_summary


---

## è®­ç»ƒé…ç½®å»ºè®®

### Version 2 è®­ç»ƒå‚æ•°ï¼ˆms-swiftï¼‰

```bash
CUDA_VISIBLE_DEVICES=0 \
swift sft \
    --model Qwen/Qwen3-8B-Instruct \
    --train_type lora \
    --dataset data/sft/chengla_v2/train_latest.jsonl \
    --val_dataset data/sft/chengla_v2/val_latest.jsonl \
    --torch_dtype bfloat16 \
    --num_train_epochs 3 \
    --per_device_train_batch_size 2 \
    --per_device_eval_batch_size 2 \
    --learning_rate 1e-4 \
    --lora_rank 16 \
    --lora_alpha 32 \
    --target_modules all-linear \
    --gradient_accumulation_steps 8 \
    --eval_steps 100 \
    --save_steps 100 \
    --save_total_limit 3 \
    --logging_steps 10 \
    --max_length 2048 \
    --output_dir output/chengla_v2 \
    --warmup_ratio 0.1
```

**å…³é”®å‚æ•°è¯´æ˜**ï¼š
- `num_train_epochs=3`: å¤šä»»åŠ¡å­¦ä¹ éœ€è¦æ›´å¤šepoch
- `max_length=2048`: å¯¹è¯å†å²è¾ƒé•¿ï¼Œéœ€è¦æ›´å¤§çš„ä¸Šä¸‹æ–‡çª—å£
- `lora_rank=16`: ç¨å¤§çš„rankåº”å¯¹æ›´å¤æ‚çš„ä»»åŠ¡


---

## æ¨ç†æ—¶çš„ä½¿ç”¨

### Version 2 æ¨ç†ä»£ç ç¤ºä¾‹

```python
import json
from transformers import AutoModelForCausalLM, AutoTokenizer

model = AutoModelForCausalLM.from_pretrained("output/chengla_v2/final")
tokenizer = AutoTokenizer.from_pretrained("output/chengla_v2/final")

# è¾“å…¥å¯¹è¯å†å²
conversation_history = """
[é”€å”®][2025-03-03 20:47:47]ï¼šéº»çƒ¦å’±ä»¬å­©å­åŠ è€å¸ˆå¾®ä¿¡...
[å®¢æˆ·][2025-03-03 20:48:25]ï¼šå’Œå­©å­è¿˜æ²¡è”ç³»ä¸Š
...
"""

messages = [
    {"role": "system", "content": system_prompt},
    {"role": "user", "content": f"è¯·åˆ†æä»¥ä¸‹å¯¹è¯å†å²...\n\n{conversation_history}"}
]

# ç”Ÿæˆ
inputs = tokenizer.apply_chat_template(messages, return_tensors="pt")
outputs = model.generate(inputs, max_new_tokens=512)
response = tokenizer.decode(outputs[0], skip_special_tokens=True)

# è§£æJSONè¾“å‡º
try:
    result = json.loads(response)
    user_profile = result['user_profile']
    history_summary = result['history_summary']
    rewritten_query = result['rewritten_query']
except:
    print("JSONè§£æå¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥æ¨¡å‹è¾“å‡º")
```


---

## æ€»ç»“

**ä½ çš„æ–°éœ€æ±‚ï¼ˆVersion 2ï¼‰æ›´é€‚åˆå®é™…åº”ç”¨åœºæ™¯**ï¼š
- âœ… ä»åŸå§‹å¯¹è¯ç›´æ¥ç”Ÿæˆæ‰€éœ€ä¿¡æ¯
- âœ… å‡å°‘äººå·¥é¢„å¤„ç†ç¯èŠ‚
- âœ… æ¨¡å‹å­¦åˆ°æ›´å…¨é¢çš„èƒ½åŠ›

**å»ºè®®**ï¼š
1. å…ˆç”¨ Version 2 è®­ç»ƒçœ‹æ•ˆæœ
2. å¦‚æœJSONæ ¼å¼è¾“å‡ºä¸ç¨³å®šï¼Œå¯ä»¥è€ƒè™‘ï¼š
   - å¢åŠ è®­ç»ƒæ•°æ®é‡
   - æé«˜è®­ç»ƒepoch
   - æˆ–é™çº§ä½¿ç”¨ Version 1


