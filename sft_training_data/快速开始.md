# å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸ¯ 3æ­¥å¼€å§‹ä½¿ç”¨

### Step 1: å‡†å¤‡æ•°æ®

ç¡®ä¿Excelæ•°æ®æ–‡ä»¶å­˜åœ¨ï¼š
```
code/data/æ©™å•¦-query_RL_è®­ç»ƒé›†.xlsx
```

### Step 2: è¿è¡Œè½¬æ¢

```bash
cd scripts
python convert_to_sft_format_v2.py
```

### Step 3: æ£€æŸ¥è¾“å‡º

ç”Ÿæˆçš„æ–‡ä»¶ä½äºï¼š
```
../data/sft/chengla_v2/
â”œâ”€â”€ train_latest.jsonl      # è®­ç»ƒé›†
â”œâ”€â”€ val_latest.jsonl        # éªŒè¯é›†  
â”œâ”€â”€ test_latest.jsonl       # æµ‹è¯•é›†
â”œâ”€â”€ stats_report.json       # ç»Ÿè®¡æŠ¥å‘Š
â””â”€â”€ sample_examples.json    # æ ·æœ¬ç¤ºä¾‹
```

---

## ğŸ“Š æ•°æ®æ ¼å¼è¯´æ˜

### è¾“å…¥ï¼ˆExcelï¼‰
- æœ€ç»ˆä¼ å‚ä¸Šä¸‹æ–‡ â†’ å¯¹è¯å†å²
- rewritten_query â†’ æ”¹å†™çš„query
- user_profile â†’ ç”¨æˆ·ç”»åƒ
- history_summary â†’ å†å²æ‘˜è¦

### è¾“å‡ºï¼ˆJSONLï¼‰
æ¯è¡Œä¸€ä¸ªè®­ç»ƒæ ·æœ¬ï¼š

```json
{
  "messages": [
    {"role": "system", "content": "..."},
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "<think>\n\n</think>\n\n{JSON}"}
  ],
  "metadata": {...}
}
```

---

## ğŸ§ª è¿è¡Œæµ‹è¯•

```bash
cd tests
python test_think_tag.py
```

é¢„æœŸçœ‹åˆ°ï¼š
```
[OK] <think>æ ‡è®°ä½ç½®æ­£ç¡®
[OK] JSONæ ¼å¼æ­£ç¡®
[OK] æ‰€æœ‰å­—æ®µå®Œæ•´
```

---

## ğŸ“– æŸ¥çœ‹æ–‡æ¡£

è¯¦ç»†è¯´æ˜åœ¨ `docs/` ç›®å½•ï¼š

| æ–‡æ¡£ | å†…å®¹ |
|------|------|
| System_Promptä¿®æ”¹è¯´æ˜.md | System Promptè¯¦è§£ |
| Thinkæ ‡è®°ä½¿ç”¨è¯´æ˜.md | <think>æ ‡è®°åŠŸèƒ½ |
| æ•°æ®æ ¼å¼å¯¹æ¯”è¯´æ˜.md | V1/V2ç‰ˆæœ¬å¯¹æ¯” |

---

## âš™ï¸ è‡ªå®šä¹‰é…ç½®

ç¼–è¾‘ `scripts/convert_to_sft_format_v2.py`ï¼š

```python
# ä¿®æ”¹ç§Ÿæˆ·ID
converter = SFTDataConverterV2(tenant_id="your_tenant")

# è°ƒæ•´æ•°æ®é›†åˆ’åˆ†æ¯”ä¾‹
converter.convert_excel_to_jsonl(
    train_ratio=0.8,   # è®­ç»ƒé›†80%
    val_ratio=0.1,     # éªŒè¯é›†10%
    # æµ‹è¯•é›†è‡ªåŠ¨ä¸ºå‰©ä½™10%
)

# å…³é—­è´¨é‡è¿‡æ»¤
converter.convert_excel_to_jsonl(
    quality_filter=False
)
```

---

## ğŸš€ å¼€å§‹è®­ç»ƒ

ä½¿ç”¨ç”Ÿæˆçš„æ•°æ®å¼€å§‹SFTè®­ç»ƒï¼š

```bash
CUDA_VISIBLE_DEVICES=0 \
swift sft \
    --model Qwen/Qwen3-8B-Instruct \
    --dataset train_latest.jsonl \
    --val_dataset val_latest.jsonl \
    --num_train_epochs 3 \
    --learning_rate 1e-4 \
    --max_length 2048 \
    --output_dir output/chengla_v2
```

è¯¦è§æ–‡æ¡£ï¼š
- [MDæ–¹æ¡ˆæ–‡æ¡£](../../Plan_md/SalesRAG_Query_Rewrite_RL_Training_Plan.md)
- ms-swiftå®˜æ–¹æ–‡æ¡£

---

## â“ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•ä¿®æ”¹System Promptï¼Ÿ

A: ç¼–è¾‘ `scripts/convert_to_sft_format_v2.py` ä¸­çš„ `self.system_prompt`

### Q: ä¸ºä»€ä¹ˆæœ‰<think>æ ‡è®°ï¼Ÿ

A: ä¿æŒæ¨¡å‹æ¨ç†èƒ½åŠ›ã€‚è¯¦è§ `docs/Thinkæ ‡è®°ä½¿ç”¨è¯´æ˜.md`

### Q: æ•°æ®è´¨é‡å¦‚ä½•è¿‡æ»¤ï¼Ÿ

A: è‡ªåŠ¨è¿‡æ»¤ï¼š
- ç©ºå€¼æ ·æœ¬
- é•¿åº¦å¼‚å¸¸ï¼ˆ<5æˆ–>200å­—ç¬¦ï¼‰
- æ”¹å†™å‰åç›¸åŒçš„æ ·æœ¬

### Q: å¦‚ä½•æŸ¥çœ‹æ ·æœ¬ï¼Ÿ

A: æŸ¥çœ‹ `sample_examples.json` æˆ–è®­ç»ƒæ—¥å¿—ä¸­çš„ç¤ºä¾‹è¾“å‡º

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

1. æŸ¥çœ‹ `README.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—
2. æŸ¥çœ‹ `docs/` - è¯¦ç»†æ–‡æ¡£
3. æŸ¥çœ‹æ ¹ç›®å½• `é¡¹ç›®æ–‡ä»¶ç»“æ„è¯´æ˜.md` - é¡¹ç›®æ•´ä½“ç»“æ„

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- âœ… å¤šä»»åŠ¡è¾“å‡ºï¼ˆprofile + summary + queryï¼‰
- âœ… <think>æ ‡è®°ä¿æŒæ¨ç†èƒ½åŠ›
- âœ… è‡ªåŠ¨æ•°æ®æ¸…æ´—å’Œè´¨é‡è¿‡æ»¤
- âœ… è‡ªåŠ¨åˆ’åˆ†è®­ç»ƒ/éªŒè¯/æµ‹è¯•é›†
- âœ… è¯¦ç»†çš„ç»Ÿè®¡æŠ¥å‘Š

å¼€å§‹ä½¿ç”¨å§ï¼ ğŸ‰

