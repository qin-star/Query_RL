# 快速开始指南

## 🎯 3步开始使用

### Step 1: 准备数据

确保Excel数据文件存在：
```
code/data/橙啦-query_RL_训练集.xlsx
```

### Step 2: 运行转换

```bash
cd scripts
python convert_to_sft_format_v2.py
```

### Step 3: 检查输出

生成的文件位于：
```
../data/sft/chengla_v2/
├── train_latest.jsonl      # 训练集
├── val_latest.jsonl        # 验证集  
├── test_latest.jsonl       # 测试集
├── stats_report.json       # 统计报告
└── sample_examples.json    # 样本示例
```

---

## 📊 数据格式说明

### 输入（Excel）
- 最终传参上下文 → 对话历史
- rewritten_query → 改写的query
- user_profile → 用户画像
- history_summary → 历史摘要

### 输出（JSONL）
每行一个训练样本：

```json
{
  "messages": [
    {"role": "system", "content": "..."},
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "<think>\n\n</think>\n\n{JSON}"}
  ],
  "metadata": {...}
}
```

---

## 🧪 运行测试

```bash
cd tests
python test_think_tag.py
```

预期看到：
```
[OK] <think>标记位置正确
[OK] JSON格式正确
[OK] 所有字段完整
```

---

## 📖 查看文档

详细说明在 `docs/` 目录：

| 文档 | 内容 |
|------|------|
| System_Prompt修改说明.md | System Prompt详解 |
| Think标记使用说明.md | <think>标记功能 |
| 数据格式对比说明.md | V1/V2版本对比 |

---

## ⚙️ 自定义配置

编辑 `scripts/convert_to_sft_format_v2.py`：

```python
# 修改租户ID
converter = SFTDataConverterV2(tenant_id="your_tenant")

# 调整数据集划分比例
converter.convert_excel_to_jsonl(
    train_ratio=0.8,   # 训练集80%
    val_ratio=0.1,     # 验证集10%
    # 测试集自动为剩余10%
)

# 关闭质量过滤
converter.convert_excel_to_jsonl(
    quality_filter=False
)
```

---

## 🚀 开始训练

使用生成的数据开始SFT训练：

```bash
CUDA_VISIBLE_DEVICES=0 \
swift sft \
    --model Qwen/Qwen3-8B-Instruct \
    --dataset train_latest.jsonl \
    --val_dataset val_latest.jsonl \
    --num_train_epochs 3 \
    --learning_rate 1e-4 \
    --max_length 2048 \
    --output_dir output/chengla_v2
```

详见文档：
- [MD方案文档](../../Plan_md/SalesRAG_Query_Rewrite_RL_Training_Plan.md)
- ms-swift官方文档

---

## ❓ 常见问题

### Q: 如何修改System Prompt？

A: 编辑 `scripts/convert_to_sft_format_v2.py` 中的 `self.system_prompt`

### Q: 为什么有<think>标记？

A: 保持模型推理能力。详见 `docs/Think标记使用说明.md`

### Q: 数据质量如何过滤？

A: 自动过滤：
- 空值样本
- 长度异常（<5或>200字符）
- 改写前后相同的样本

### Q: 如何查看样本？

A: 查看 `sample_examples.json` 或训练日志中的示例输出

---

## 📞 需要帮助？

1. 查看 `README.md` - 完整使用指南
2. 查看 `docs/` - 详细文档
3. 查看根目录 `项目文件结构说明.md` - 项目整体结构

---

## ✨ 核心特性

- ✅ 多任务输出（profile + summary + query）
- ✅ <think>标记保持推理能力
- ✅ 自动数据清洗和质量过滤
- ✅ 自动划分训练/验证/测试集
- ✅ 详细的统计报告

开始使用吧！ 🎉

