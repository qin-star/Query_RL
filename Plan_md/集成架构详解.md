# DeepRetrieval Ã— LangChain-Chatchat é›†æˆæ¶æ„è¯¦è§£

> å¯è§†åŒ–ç³»ç»Ÿæ¶æ„å’Œæ•°æ®æµ

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·äº¤äº’å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Web UI  â”‚      â”‚   API    â”‚      â”‚  ç§»åŠ¨ç«¯  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â”‚
â”‚        â”‚                 â”‚                  â”‚                    â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LangChain-Chatchat æ ¸å¿ƒæœåŠ¡                        â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    API Router                              â”‚ â”‚
â”‚  â”‚  /chat/kb_chat  â”‚  /chat/file_chat  â”‚  /knowledge_base   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Chat Handler (kb_chat.py)                     â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  1. æ¥æ”¶ç”¨æˆ·Query                                          â”‚ â”‚
â”‚  â”‚  2. è°ƒç”¨Queryé‡å†™ä¸­é—´ä»¶ â—„â”€â”€â”€â”€â”€â”€â”€â”                         â”‚ â”‚
â”‚  â”‚  3. å‘é‡æ£€ç´¢                    â”‚                          â”‚ â”‚
â”‚  â”‚  4. ç”Ÿæˆå›ç­”                    â”‚                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚             â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                          â”‚ â”‚
â”‚  â”‚     â”‚ QueryRewriterMiddleware â”‚â”‚  â—„â”€â”€ â­ æ ¸å¿ƒé›†æˆç‚¹       â”‚ â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                          â”‚ â”‚
â”‚  â”‚                   â”‚             â”‚                          â”‚ â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                          â”‚ â”‚
â”‚  â”‚         â”‚ Model Rewrite?    â”‚   â”‚                          â”‚ â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                          â”‚ â”‚
â”‚  â”‚            Yes    â”‚     No      â”‚                          â”‚ â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                          â”‚ â”‚
â”‚  â”‚         â”‚ Rule-based?       â”‚â”€â”€â”€â”˜                          â”‚ â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚ â”‚
â”‚  â”‚                   â”‚                                         â”‚ â”‚
â”‚  â”‚                   â””â”€â–º Original Query (é™çº§)                â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Knowledge Base Service                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚  â”‚   FAISS    â”‚  â”‚   Milvus   â”‚  â”‚  Chroma    â”‚        â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   å‘é‡æ•°æ®åº“ / çŸ¥è¯†åº“   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


                              â•‘
                              â•‘  gRPC / HTTP
                              â•‘
                              â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DeepRetrieval æŸ¥è¯¢é‡å†™æœåŠ¡                         â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     vLLM Server                            â”‚ â”‚
â”‚  â”‚                  (port: 8001)                              â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Model: DeepRetrieval Fine-tuned LLM                 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  (åŸºäºQwen2/DeepSeekç­‰è®­ç»ƒ)                          â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  API: /v1/chat/completions (OpenAI Compatible)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ•°æ®æµè¯¦è§£

### å®Œæ•´è¯·æ±‚æµç¨‹

```
ç”¨æˆ·è¾“å…¥: "èƒ¶åŸè›‹ç™½æ€ä¹ˆåƒ"
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. LangChain-Chatchatæ¥æ”¶è¯·æ±‚   â”‚
â”‚    POST /chat/kb_chat             â”‚
â”‚    {                              â”‚
â”‚      "query": "èƒ¶åŸè›‹ç™½æ€ä¹ˆåƒ",   â”‚
â”‚      "kb_name": "wuboshi_faq"     â”‚
â”‚    }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è¿›å…¥kb_chatå¤„ç†å‡½æ•°           â”‚
â”‚    async def kb_chat(...)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è°ƒç”¨QueryRewriterMiddleware                              â”‚
â”‚                                                               â”‚
â”‚    rewriter = get_query_rewriter()                          â”‚
â”‚    result = rewriter.rewrite("èƒ¶åŸè›‹ç™½æ€ä¹ˆåƒ")              â”‚
â”‚                                                               â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚ 3a. å°è¯•æ¨¡å‹é‡å†™                                    â”‚  â”‚
â”‚    â”‚     POST http://localhost:8001/v1/chat/completions â”‚  â”‚
â”‚    â”‚     {                                                â”‚  â”‚
â”‚    â”‚       "model": "query-rewrite",                     â”‚  â”‚
â”‚    â”‚       "messages": [{                                â”‚  â”‚
â”‚    â”‚         "role": "user",                             â”‚  â”‚
â”‚    â”‚         "content": "ä¼˜åŒ–æŸ¥è¯¢: èƒ¶åŸè›‹ç™½æ€ä¹ˆåƒ"       â”‚  â”‚
â”‚    â”‚       }]                                             â”‚  â”‚
â”‚    â”‚     }                                                â”‚  â”‚
â”‚    â”‚                                                       â”‚  â”‚
â”‚    â”‚     â†“ (145ms)                                        â”‚  â”‚
â”‚    â”‚                                                       â”‚  â”‚
â”‚    â”‚     Response:                                        â”‚  â”‚
â”‚    â”‚     "èƒ¶åŸè›‹ç™½è‚½ ä½¿ç”¨æ–¹æ³• æ¨èç”¨é‡ é€‚ç”¨äººç¾¤"         â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â”‚    è¿”å›:                                                     â”‚
â”‚    {                                                          â”‚
â”‚      "original": "èƒ¶åŸè›‹ç™½æ€ä¹ˆåƒ",                           â”‚
â”‚      "rewritten": "èƒ¶åŸè›‹ç™½è‚½ ä½¿ç”¨æ–¹æ³• æ¨èç”¨é‡ é€‚ç”¨äººç¾¤",   â”‚
â”‚      "method": "model",                                      â”‚
â”‚      "success": true,                                        â”‚
â”‚      "latency_ms": 145                                       â”‚
â”‚    }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ä½¿ç”¨é‡å†™åçš„Queryè¿›è¡Œå‘é‡æ£€ç´¢                            â”‚
â”‚                                                               â”‚
â”‚    docs = search_docs(                                       â”‚
â”‚        query="èƒ¶åŸè›‹ç™½è‚½ ä½¿ç”¨æ–¹æ³• æ¨èç”¨é‡ é€‚ç”¨äººç¾¤",        â”‚
â”‚        kb_name="wuboshi_faq",                                â”‚
â”‚        top_k=5                                               â”‚
â”‚    )                                                          â”‚
â”‚                                                               â”‚
â”‚    â†“                                                          â”‚
â”‚                                                               â”‚
â”‚    å‘é‡æ•°æ®åº“è¿”å›Top-5æ–‡æ¡£:                                  â”‚
â”‚    [                                                          â”‚
â”‚      {                                                        â”‚
â”‚        "content": "å¯Œé“è½¯ç³–ä½¿ç”¨æ–¹æ³•ä¸ºæ¯å¤©æ¨è3ç²’...",        â”‚
â”‚        "score": 0.89,                                        â”‚
â”‚        "metadata": {...}                                     â”‚
â”‚      },                                                       â”‚
â”‚      ...                                                      â”‚
â”‚    ]                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ„å»ºPromptå¹¶è°ƒç”¨LLMç”Ÿæˆå›ç­”                               â”‚
â”‚                                                               â”‚
â”‚    prompt = f"""                                             â”‚
â”‚    å‚è€ƒä»¥ä¸‹å†…å®¹å›ç­”ç”¨æˆ·é—®é¢˜:                                 â”‚
â”‚    {docs}                                                     â”‚
â”‚                                                               â”‚
â”‚    ç”¨æˆ·é—®é¢˜: èƒ¶åŸè›‹ç™½æ€ä¹ˆåƒ                                  â”‚
â”‚    """                                                        â”‚
â”‚                                                               â”‚
â”‚    answer = llm.generate(prompt)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. è¿”å›æœ€ç»ˆç»“æœç»™ç”¨æˆ·                                        â”‚
â”‚    {                                                          â”‚
â”‚      "answer": "èƒ¶åŸè›‹ç™½è‚½çš„ä½¿ç”¨æ–¹æ³•ä¸º...",                  â”‚
â”‚      "docs": [...],                                           â”‚
â”‚      "query_rewrite": {                                      â”‚
â”‚        "original": "èƒ¶åŸè›‹ç™½æ€ä¹ˆåƒ",                         â”‚
â”‚        "rewritten": "èƒ¶åŸè›‹ç™½è‚½ ä½¿ç”¨æ–¹æ³•..."                 â”‚
â”‚      }                                                        â”‚
â”‚    }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. QueryRewriterMiddleware

```
QueryRewriterMiddleware
â”‚
â”œâ”€ é…ç½®ç®¡ç†
â”‚  â”œâ”€ enable: bool           # æ€»å¼€å…³
â”‚  â”œâ”€ api_url: str           # vLLMåœ°å€
â”‚  â”œâ”€ timeout: float         # è¶…æ—¶æ—¶é—´
â”‚  â””â”€ fallback_enabled: bool # é™çº§å¼€å…³
â”‚
â”œâ”€ æ ¸å¿ƒæ–¹æ³•
â”‚  â”œâ”€ rewrite(query) â†’ dict
â”‚  â”‚  â”œâ”€ _model_rewrite()        # Level 1
â”‚  â”‚  â”œâ”€ _rule_based_rewrite()   # Level 2
â”‚  â”‚  â””â”€ return original_query   # Level 3
â”‚  â”‚
â”‚  â”œâ”€ _build_prompt(query)
â”‚  â””â”€ _parse_response(content)
â”‚
â””â”€ è¾…åŠ©åŠŸèƒ½
   â”œâ”€ ç¼“å­˜æœºåˆ¶ (å¯é€‰)
   â”œâ”€ ç›‘æ§åŸ‹ç‚¹
   â””â”€ æ—¥å¿—è®°å½•
```

### 2. ä¸‰çº§é™çº§æœºåˆ¶

```mermaid
graph TD
    A[ç”¨æˆ·Query] --> B{å¯ç”¨é‡å†™?}
    B -->|No| Z[è¿”å›åŸå§‹Query]
    B -->|Yes| C[è°ƒç”¨vLLM]
    
    C --> D{æˆåŠŸ?}
    D -->|Yes| E[è¿”å›æ¨¡å‹é‡å†™ç»“æœ]
    D -->|No| F{è¶…æ—¶/é”™è¯¯}
    
    F --> G{å¯ç”¨é™çº§?}
    G -->|No| Z
    G -->|Yes| H[è§„åˆ™é‡å†™]
    
    H --> I{è§„åˆ™åŒ¹é…?}
    I -->|Yes| J[è¿”å›è§„åˆ™é‡å†™ç»“æœ]
    I -->|No| Z
    
    E --> K[method='model']
    J --> L[method='rule']
    Z --> M[method='none']
```

### 3. é…ç½®ç»§æ‰¿é“¾

```
Environment Variables (æœ€é«˜ä¼˜å…ˆçº§)
   â†“ (è¦†ç›–)
YAMLé…ç½®æ–‡ä»¶ (data/query_rewrite_settings.yaml)
   â†“ (è¦†ç›–)
Settingsç±»é»˜è®¤å€¼ (chatchat/settings.py)
   â†“ (è¦†ç›–)
Middlewareé»˜è®¤å€¼ (middleware/query_rewriter.py)
```

ç¤ºä¾‹:
```python
# ä¼˜å…ˆçº§ç¤ºä¾‹
export QUERY_REWRITE_ENABLE=true    # æœ€é«˜ä¼˜å…ˆçº§

# YAMLé…ç½®
query_rewrite_settings:
  enable: false                      # è¢«ç¯å¢ƒå˜é‡è¦†ç›–

# Settingsç±»
class QueryRewriteSettings:
    enable: bool = True               # è¢«YAMLè¦†ç›–

# æœ€ç»ˆç”Ÿæ•ˆ: enable = true (ç¯å¢ƒå˜é‡)
```

---

## ğŸ“Š æ€§èƒ½åˆ†æ

### å»¶è¿Ÿåˆ†è§£

```
æ€»å»¶è¿Ÿ = Queryé‡å†™å»¶è¿Ÿ + å‘é‡æ£€ç´¢å»¶è¿Ÿ + LLMç”Ÿæˆå»¶è¿Ÿ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¯·æ±‚                                      â”‚
â”‚  â”‚                                              â”‚
â”‚  â”œâ”€ Queryé‡å†™ (100-300ms)                     â”‚
â”‚  â”‚  â”œâ”€ ç½‘ç»œå¾€è¿” (20-50ms)                     â”‚
â”‚  â”‚  â”œâ”€ æ¨¡å‹æ¨ç† (80-200ms)                    â”‚
â”‚  â”‚  â””â”€ è§£æå“åº” (10-50ms)                     â”‚
â”‚  â”‚                                              â”‚
â”‚  â”œâ”€ å‘é‡æ£€ç´¢ (50-150ms)                       â”‚
â”‚  â”‚  â”œâ”€ Query embedding (30-80ms)              â”‚
â”‚  â”‚  â””â”€ å‘é‡æœç´¢ (20-70ms)                     â”‚
â”‚  â”‚                                              â”‚
â”‚  â””â”€ LLMç”Ÿæˆ (1000-3000ms)                     â”‚
â”‚     â””â”€ Tokenç”Ÿæˆ                               â”‚
â”‚                                                 â”‚
â”‚  æ€»è®¡: 1150-3450ms                             â”‚
â”‚  (Queryé‡å†™å æ¯”: 8-10%)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŒ–å»ºè®®**:
1. Queryé‡å†™é‡‡ç”¨å¼‚æ­¥è°ƒç”¨,ä¸é˜»å¡ä¸»æµç¨‹
2. å¯ç”¨ç¼“å­˜,å‘½ä¸­ç‡å¯è¾¾40-60%
3. è¶…æ—¶æ—¶é—´è®¾ä¸º2s,å¿«é€Ÿé™çº§

### èµ„æºæ¶ˆè€—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  vLLMæœåŠ¡ (DeepRetrieval)               â”‚
â”‚  â”œâ”€ GPUå†…å­˜: 8-16GB (7Bæ¨¡å‹)           â”‚
â”‚  â”œâ”€ CPU: 4-8æ ¸                          â”‚
â”‚  â””â”€ å¹¶å‘èƒ½åŠ›: 10-50 QPS                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LangChain-Chatchat                     â”‚
â”‚  â”œâ”€ é¢å¤–å†…å­˜: +100MB (ä¸­é—´ä»¶)          â”‚
â”‚  â”œâ”€ é¢å¤–CPU: å¾®ä¹å…¶å¾®                  â”‚
â”‚  â””â”€ ç½‘ç»œ: +1ä¸ªHTTPè¿æ¥                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å®‰å…¨æ¶æ„

### ç½‘ç»œéš”ç¦»

```
Internet
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nginx / åå‘ä»£ç†   â”‚  â† å…¬ç½‘è®¿é—®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LangChain-Chatchat  â”‚  â† å†…ç½‘æœåŠ¡
â”‚  (port: 7861)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚  ä»…å†…ç½‘è®¿é—®
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DeepRetrieval vLLM  â”‚  â† å†…ç½‘æœåŠ¡
â”‚  (port: 8001)       â”‚     ä¸å¯¹å¤–æš´éœ²
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¿é—®æ§åˆ¶

```python
# åœ¨QueryRewriterMiddlewareä¸­æ·»åŠ è®¤è¯
class QueryRewriterMiddleware:
    def __init__(self, api_key: str = None):
        self.api_key = api_key or os.getenv("VLLM_API_KEY")
        
        self.client = OpenAI(
            api_key=self.api_key,  # æ·»åŠ è®¤è¯
            base_url=api_url
        )
```

---

## ğŸ“ˆ ç›‘æ§æ¶æ„

### ç›‘æ§æŒ‡æ ‡ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç›‘æ§ä¸­å¿ƒ                              â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ€§èƒ½æŒ‡æ ‡    â”‚  â”‚  ä¸šåŠ¡æŒ‡æ ‡    â”‚  â”‚  è´¨é‡æŒ‡æ ‡    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ - å»¶è¿Ÿ       â”‚  â”‚ - è¯·æ±‚é‡     â”‚  â”‚ - æˆåŠŸç‡     â”‚  â”‚
â”‚  â”‚ - QPS        â”‚  â”‚ - ç”¨æˆ·æ•°     â”‚  â”‚ - å‡†ç¡®ç‡     â”‚  â”‚
â”‚  â”‚ - å¹¶å‘æ•°     â”‚  â”‚ - æ´»è·ƒåº¦     â”‚  â”‚ - æ»¡æ„åº¦     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚               å‘Šè­¦è§„åˆ™                               â”‚â”‚
â”‚  â”‚  - æˆåŠŸç‡ < 90% â†’ å‘é€å‘Šè­¦                          â”‚â”‚
â”‚  â”‚  - å»¶è¿Ÿ > 1s (P95) â†’ å‘é€å‘Šè­¦                       â”‚â”‚
â”‚  â”‚  - æœåŠ¡ä¸å¯ç”¨ â†’ ç«‹å³å‘Šè­¦                            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—¥å¿—æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨æ—¥å¿—                                â”‚
â”‚                                           â”‚
â”‚  kb_chat.py:                             â”‚
â”‚    ğŸ”„ [Queryé‡å†™] model (145ms):        â”‚
â”‚       'èƒ¶åŸè›‹ç™½æ€ä¹ˆåƒ' ->                â”‚
â”‚       'èƒ¶åŸè›‹ç™½è‚½ ä½¿ç”¨æ–¹æ³•...'          â”‚
â”‚                                           â”‚
â”‚  query_rewriter.py:                      â”‚
â”‚    âœ“ è°ƒç”¨vLLMæˆåŠŸ                        â”‚
â”‚    âœ— è¶…æ—¶,é™çº§åˆ°è§„åˆ™é‡å†™                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ—¥å¿—èšåˆ (å¯é€‰)                         â”‚
â”‚  - ELK Stack                             â”‚
â”‚  - Grafana Loki                          â”‚
â”‚  - é˜¿é‡Œäº‘æ—¥å¿—æœåŠ¡                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ éƒ¨ç½²æ¶æ„

### å•æœºéƒ¨ç½²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å•å°æœåŠ¡å™¨                    â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  LangChain-Chatchat                â”‚â”‚
â”‚  â”‚  CPU: 8æ ¸                          â”‚â”‚
â”‚  â”‚  RAM: 16GB                         â”‚â”‚
â”‚  â”‚  Port: 7861                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  DeepRetrieval vLLM                â”‚â”‚
â”‚  â”‚  GPU: 1 x A100 (40GB)              â”‚â”‚
â”‚  â”‚  CPU: 16æ ¸                         â”‚â”‚
â”‚  â”‚  RAM: 64GB                         â”‚â”‚
â”‚  â”‚  Port: 8001                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é€‚ç”¨åœºæ™¯: å¼€å‘æµ‹è¯•ã€å°è§„æ¨¡ç”Ÿäº§(< 100ç”¨æˆ·)
```

### åˆ†å¸ƒå¼éƒ¨ç½²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è´Ÿè½½å‡è¡¡å™¨     â”‚
â”‚  (Nginx)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chat 1 â”‚ â”‚ Chat 2 â”‚  LangChain-Chatchaté›†ç¾¤
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚          â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   vLLMé›†ç¾¤      â”‚
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”   â”‚
â”‚  â”‚ 1 â”‚ â”‚ 2 â”‚   â”‚  DeepRetrievalæŸ¥è¯¢é‡å†™
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é€‚ç”¨åœºæ™¯: å¤§è§„æ¨¡ç”Ÿäº§(> 1000ç”¨æˆ·)
```

---

## ğŸ”„ æ‰©å±•æ¶æ„

### æ··åˆæ£€ç´¢æ¶æ„

```
ç”¨æˆ·Query
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Queryé‡å†™æ¨¡å—                       â”‚
â”‚  original_query â†’ rewritten_query   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚              â”‚
        â–¼               â–¼              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ è·¯å¾„1:  â”‚    â”‚ è·¯å¾„2:  â”‚   â”‚ è·¯å¾„3:  â”‚
   â”‚ åŸå§‹    â”‚    â”‚ é‡å†™    â”‚   â”‚ æ‰©å±•    â”‚
   â”‚ Query   â”‚    â”‚ Query   â”‚   â”‚ Query   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚              â”‚              â”‚
        â–¼              â–¼              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚      å‘é‡æ£€ç´¢                        â”‚
   â”‚  results_1  results_2  results_3    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ç»“æœèåˆ(RRF)  â”‚
   â”‚  - Reciprocal   â”‚
   â”‚  - Weighted     â”‚
   â”‚  - Cascade      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   é‡æ’åº(å¯é€‰)  â”‚
   â”‚  - Cross-Encoderâ”‚
   â”‚  - Reranker     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
      æœ€ç»ˆTop-Kæ–‡æ¡£
```

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. é…ç½®æœ€ä½³å®è·µ

```yaml
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
query_rewrite_settings:
  enable: true
  api_url: "http://internal-vllm:8001/v1"  # ä½¿ç”¨å†…ç½‘åŸŸå
  timeout: 1.5  # é€‚ä¸­çš„è¶…æ—¶æ—¶é—´
  fallback_enabled: true  # åŠ¡å¿…å¯ç”¨
  
  cache:
    enabled: true  # å¯ç”¨ç¼“å­˜
    max_size: 5000  # æ ¹æ®å†…å­˜è°ƒæ•´
    ttl: 3600
```

### 2. ç›‘æ§æœ€ä½³å®è·µ

```python
# å…³é”®æŒ‡æ ‡ç›‘æ§
metrics = {
    "query_rewrite_latency_p95": 300,  # ms
    "query_rewrite_success_rate": 0.95,  # 95%
    "fallback_rate": 0.05,  # 5%
    "cache_hit_rate": 0.4,  # 40%
}

# å‘Šè­¦é˜ˆå€¼
alerts = {
    "success_rate_threshold": 0.90,  # < 90% å‘Šè­¦
    "latency_threshold_ms": 500,  # > 500ms å‘Šè­¦
    "service_down": True,  # æœåŠ¡ä¸å¯ç”¨ç«‹å³å‘Šè­¦
}
```

### 3. å®¹é‡è§„åˆ’

```python
# å•vLLMå®ä¾‹å®¹é‡è¯„ä¼°
capacity_per_instance = {
    "qps": 20,  # æŸ¥è¯¢/ç§’
    "concurrent_requests": 10,
    "avg_latency_ms": 200,
    "gpu_memory_gb": 16,  # 7Bæ¨¡å‹
}

# æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¡ç®—å®ä¾‹æ•°
target_qps = 100
instances_needed = ceil(target_qps / capacity_per_instance["qps"])
# = 5ä¸ªå®ä¾‹
```

---

## ğŸ“š æ€»ç»“

æœ¬é›†æˆæ¶æ„çš„æ ¸å¿ƒç‰¹ç‚¹:

âœ… **æ¨¡å—åŒ–**: ä¸­é—´ä»¶ç‹¬ç«‹,æ˜“äºç»´æŠ¤  
âœ… **é«˜å¯ç”¨**: ä¸‰çº§é™çº§,ä¿è¯ç¨³å®šæ€§  
âœ… **å¯è§‚æµ‹**: å®Œæ•´çš„ç›‘æ§å’Œæ—¥å¿—  
âœ… **å¯æ‰©å±•**: æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²  
âœ… **é«˜æ€§èƒ½**: æŸ¥è¯¢é‡å†™å»¶è¿Ÿ<300ms  

é€‚ç”¨äºå„ç§è§„æ¨¡çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²!

